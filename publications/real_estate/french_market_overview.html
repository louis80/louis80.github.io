<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Cheat Sheet</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
    <link rel="shortcut icon" type="image/png" href="https://img.icons8.com/nolan/64/000000/programming-flag.png">
    <link rel="stylesheet" href="../../../css/style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

    <!-- code snippets -->
    <link rel="stylesheet" href="../../../packages/prism/prism.css">
    <script src="../../../packages/prism/prism.js"></script>
    <style>
        .main-header {
          position: relative;
          display: flex;
          justify-content: space-between;
          height: 400px;
          color: #FFF;
          background-size: cover;
          background-image: url("img/real_estate3.jpg");
          background-repeat: no-repeat;
          background-position: center;
          margin-bottom: 20px;
        }

        .main-header__intro-wrapper {
          background: rgba(255, 255, 255, 0);
        }

        .table_df{
          vertical-align:middle; text-align: center;
        }
    </style>
</head>
<body>
<!-- partial:index.partial.html -->
<div class="grid">
  <header class="header">
    <i class="fas fa-bars header__menu"></i>
    <div class="header__search">
      <input class="header__input" placeholder="Search..." />
    </div>
  </header>

  <aside id="includedSidenav" class="sidenav"> </aside>

  <main class="main">
    <div class="main-header">
      <div class="main-header__intro-wrapper">
        <div class="main-header__welcome">
            <!--<div class="main-header__welcome-title text-light"><strong>Publication > Real Estate</strong></div>
            <div class="main-header__welcome-subtitle text-light"> An overview of the french real estate market </div>-->
        </div>
      </div>
    </div> <!-- end of header -->

    <!-- ############################################################### -->
    <article class='post'>
        <span class="title_article"><strong>An overview of the french real estate market</strong> </span>

        <span class="text_article">
          At the end of 2018, the French government published an open source dataset to meet an objective of transparency of the French real estate market.
          This data references the real estate transactions that took place during the last five years on the metropolitan territory.<br><br>

          <div class="alert alert-info">
            <i class="fa fa-info-circle"></i>
            The dataset is available from the French Ministry of Economy and Finance website:<br>
            <a target="_blank" rel="noopener noreferrer" href="https://www.data.gouv.fr/en/datasets/demandes-de-valeurs-foncieres/" class="alert-link">https://www.data.gouv.fr/en/datasets/demandes-de-valeurs-foncieres/</a>.
          </div>

          This short study aims to firstly explore, clean and analyse this dataset for, in a second time highlight some housing price related variables.
        </span>

        <span class="title_article" style="font-size: 30px;"><strong>Part I. Exploratory data analysis</strong> </span>
        <span class="subtitle_article">Collecting and cleaning the data</span>
        <span class="text_article">
          As the dataset is quite huge, Etalab (a government organisation in charge of opening and sharing public data) implemented a bash script allowing to import the data into a database.
          Once this step achieved, it's easier to access the data needed with SQL request. <br><br>

          Each row of the database corresponds to a real estate transaction and for each of them a lot of variables are informed.
          However many of those are quite similar, therefore in order to achieve this study only few of them will be used:<br><br>

          <table class="table">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Description</th>
                <th scope="col">Tags</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style='vertical-align:middle;'>Date of mutation</td>
                <td style='vertical-align:middle;'>Date of signature of the contract</td>
                <td><div class="alert alert-success" style='width:100%; margin:0; padding:8px; text-align: center;'> Valuable </div></td>
              </tr>
              <tr>
                <td style='vertical-align:middle;'>Nature of the mutation</td>
                <td style='vertical-align:middle;'>Sale, sale on the future state of completion, sale of land to build, adjudication, expropriation or exchange</td>
                <td><div class="alert alert-success" style='width:100%; margin:0; padding:8px; text-align: center;'> Valuable </div></td>
              </tr>
              <tr>
                <td style='vertical-align:middle;'>Property value</td>
                <td style='vertical-align:middle;'>Net price seller</td>
                <td><div class="alert alert-success" style='width:100%; margin:0; padding:8px; text-align: center;'> Valuable </div></td>
              </tr>
              <tr>
                <td style='vertical-align:middle;'>Aera of the property</td>
                <td style='vertical-align:middle;'>Surface measured on the ground between walls or separations and rounded to the lower square meter</td>
                <td><div class="alert alert-warning" style='width:100%; margin:0; padding:8px; text-align: center;'> duplicate </div></td>
              </tr>
              <tr>
                <td style='vertical-align:middle;'>Type of property</td>
                <td style='vertical-align:middle;'>House, apartment, dependence (isolated) or industrial and commercial space</td>
                <td><div class="alert alert-danger" style='width:100%; margin:0; padding:8px; text-align: center;'> Trash </div></td>
              </tr>
            </tbody>
          </table><br>

          As some value of important variables are missing, only rows with living space and surface of the property will be selected. A selection on the nature of the mutation will also be done.
          In addition, the price per square meter will be calculated for each of those transactions and the scope of study will be restricted to the house and apartment transactions.<br><br>

          Show code &nbsp;
          <label class="switch">
            <input type="checkbox" onclick="show_hide_div('code0');">
            <span class="slider round"></span>
          </label>
        </span>

        <pre class="language-python" id='code0' style="display:none;"><code class="language-SQL">
        SELECT count(*)
        FROM public.dvf
        WHERE surface_reelle_bati is not null
        AND valeur_fonciere is not null
        AND type_local in ('Maison', 'Appartement');
        </code></pre>



        <span class="subtitle_article">Dealing with outliers</span>
        <span class="text_article">
          # TO BE MODIFIED<br>
          Outliers in real estate data could be due to a number of reasons.
          For example, erroneous data formats, bad default values, typographical errors during data entry etc. can lead to outliers.
          Plotting the distribution of numeric columns can give a sense of outliers in the data set.<br><br>
          Huge dataset - > select aleatory values <br><br>

          Show code &nbsp;
          <label class="switch">
            <input type="checkbox" onclick="show_hide_div('code1');">
            <span class="slider round"></span>
          </label>
        </span>

        <pre class="language-python" id='code1' style="display:none;"><code class="language-python">
        # Connexion to the database
        import psycopg2

        def database_conn():
            return psycopg2.connect(host = '',
                                    port = '',
                                    database = '',
                                    user = '',
                                    password = '')

        def get_data_from_database(req):
            conn = database_conn()
            cursor = conn.cursor()
            cursor.execute(req)
            record = cursor.fetchall()
            names = list(map(lambda x: x[0], cursor.description))
            cursor.close()
            if (conn):
                conn.close()
            return record, names

        # Get the data to plot the distribution
        def get_df_distrib():
          req = """
          SELECT type_local AS type_property, ROUND(valeur_fonciere / surface_reelle_bati) AS price_msquare
          FROM public.dvf
          WHERE surface_reelle_bati is not null
          AND valeur_fonciere is not null
          AND type_local in ('Maison', 'Appartement')
          AND nature_mutation = 'Vente'
          ORDER BY RANDOM()
          LIMIT 1000000;
          """

          record, names = get_data_from_database(req)
          df = pd.DataFrame(data= record, columns=names)

          return df

        df_distrib = get_df_distrib()

        # Plot the distribution of price per square meter
        fig = px.histogram(df_distrib, x="price_msquare", color="type_property",
                 marginal="box", opacity=0.6, nbins=100)

        fig.update_layout(title_text='Distribution of the price per square meter according to the type of property')

        fig.show()
      </code></pre>

      <iframe src= "plot_french_market_overview/distrib.html", width="100%", height="650px", frameBorder="0"></iframe>

      <span class="text_article">
        graph + knoledge. explain case of Paris </br></br>
      </span>

      <span class="text_article">
        In order to get an idea of the evolution of the French real estate market on the period considered, let's look at the 10 cities with the highest number of sales.
        Once those cities are identified, we can collect the mean price per square meter and the number of sales aggregated by month:

        </br></br>
        Show code &nbsp;
        <label class="switch">
          <input type="checkbox" onclick="show_hide_div('code2');">
          <span class="slider round"></span>
        </label>
      </span>

      <pre class="language-python" id='code2' style="display:none;"><code class="language-python">
      def get_list_city(price_msquare_min, price_msquare_max, nbr_city=20):
          req = """
          SELECT SUBSTRING((nom_commune || ' ') FROM 1 FOR POSITION(' ' IN (nom_commune || ' '))) AS nom_commune
          , count(*) AS number_transaction, AVG(valeur_fonciere / surface_reelle_bati) AS mean_price_msquare
          FROM public.dvf
          WHERE surface_reelle_bati is not null
          AND valeur_fonciere is not null
          AND type_local in ('Maison', 'Appartement')
          AND nature_mutation = 'Vente'
          AND (valeur_fonciere / surface_reelle_bati) > {0}
          AND (valeur_fonciere / surface_reelle_bati) < {1}
          GROUP BY SUBSTRING((nom_commune || ' ') FROM 1 FOR POSITION(' ' IN (nom_commune || ' ')))
          ORDER BY number_transaction DESC
          LIMIT {2};
          """.format(*[price_msquare_min, price_msquare_max,nbr_city])

          record, names = get_data_from_database(req)
          df = pd.DataFrame(data= record, columns=names)
          df = df[~df.nom_commune.isin(['Le ', 'La ', 'Les '])].replace(' ','', regex=True)

          list_city = '('
          for city in list(df.nom_commune):
              list_city+= '\''+city+' \', '

          return list_city[:-2]+')'

      def get_price_volume_city(price_msquare_min, price_msquare_max, list_city):
          req = """
          SELECT SUBSTRING((nom_commune || ' ') FROM 1 FOR POSITION(' ' IN (nom_commune || ' '))) AS nom_commune, date_mutation, count(*) AS number_transaction, AVG(valeur_fonciere / surface_reelle_bati) AS mean_price_msquare
          FROM public.dvf
          WHERE surface_reelle_bati is not null
          AND valeur_fonciere is not null
          AND type_local in ('Maison', 'Appartement')
          AND nature_mutation = 'Vente'
          AND (valeur_fonciere / surface_reelle_bati) > {0}
          AND (valeur_fonciere / surface_reelle_bati) < {1}
          AND (SUBSTRING((nom_commune || ' ') FROM 1 FOR POSITION(' ' IN (nom_commune || ' ')))) in {2}
          GROUP BY SUBSTRING((nom_commune || ' ') FROM 1 FOR POSITION(' ' IN (nom_commune || ' '))), date_mutation
          """.format(*[price_msquare_min, price_msquare_max, list_city])

          record, names = get_data_from_database(req)
          df = pd.DataFrame(data= record, columns=names)
          df.mean_price_msquare = df.mean_price_msquare.apply(int)
          df.nom_commune = df.nom_commune.replace(' ','', regex=True)

          return df

      list_city = get_list_city(price_msquare_min=200, price_msquare_max=20000, nbr_city=13)
      df = get_price_volume_city(price_msquare_min=200, price_msquare_max=20000, list_city=list_city)
      </code></pre>

<!--      <div style="grid-column:1/4; width:78%; margin: auto; text-align: center; padding-left;30px;">
        <iframe src= "plot_french_market_overview/df_price_volume.html", width="800px;", height="370px", frameBorder="0"></iframe>
      </div>-->
      <style>
      .table_head th{
        height: 60px;
        background: #0e111f;
        color:white;
        vertical-align:middle;

      }
      .table_df{
        vertical-align:middle; text-align: center;
      }
      </style>



      <span class="text_article">
        <table class="table">
          <thead>
            <tr class='table_head'>
              <th scope="col" style='vertical-align:middle; text-align: center;'>date_mutation</th>
              <th scope="col" style='vertical-align:middle; text-align: center;'>nom_commune</th>
              <th scope="col" style='vertical-align:middle; text-align: center;'>number_transaction</th>
              <th scope="col" style='vertical-align:middle; text-align: center;'>mean_price_msquare</th>
            </tr>
          </thead>
          <tbody>
            <tr style='background-color:#E0E0E0;'>
              <td style='vertical-align:middle; text-align: center;'>2014-01-31T00:00:00</td>
              <td style='vertical-align:middle; text-align: center;'>Bordeaux</td>
              <td style='vertical-align:middle; text-align: center;' style='vertical-align:middle; text-align: center;'>16</td>
              <td style='vertical-align:middle; text-align: center;'>4541</td>
            </tr>
            <tr>
              <td style='vertical-align:middle; text-align: center;'>2014-02-28T00:00:00</td>
              <td style='vertical-align:middle; text-align: center;'>Bordeaux</td>
              <td style='vertical-align:middle; text-align: center;'>29</td>
              <td style='vertical-align:middle; text-align: center;'>4563</td>
            </tr>
            <tr style='background-color:#E0E0E0;'>
              <td style='vertical-align:middle; text-align: center;'>2014-03-31T00:00:00</td>
              <td style='vertical-align:middle; text-align: center;'>Bordeaux</td>
              <td style='vertical-align:middle; text-align: center;'>11</td>
              <td style='vertical-align:middle; text-align: center;'>4914</td>
            </tr>
          </tbody>
        </table><br>

          The 10 cities selected are the following ones: Bordeaux, Lille, Lyon, Marseille, Montpellier, Nantes Nice, Paris, Rennes, Toulouse</br></br>

         From this dataframe we can plot, for each of those cities, the sales number compared to the price per square meter:
        </br></br>
        Show code &nbsp;
        <label class="switch">
          <input type="checkbox" onclick="show_hide_div('code3');">
          <span class="slider round"></span>
        </label>
      </span>

      <pre class="language-python" id='code3' style="display:none;"><code class="language-python">
      def resample_monthly_df(df):
          df.set_index(pd.to_datetime(df['date_mutation']), inplace=True)
          df = df.groupby(['nom_commune']).resample('M',how='mean')
          df = df.reset_index()
          df.mean_price_msquare = df.mean_price_msquare.apply(int)
          df.number_transaction = df.number_transaction.apply(int)
          return df

      # https://plot.ly/~empet/14983/subplots-with-two-y-axes-in-each-cell/#/

      def get_trace_city(a, city, color='255, 0, 0'):
          df_city = a[a.nom_commune==city]
          trace_price = go.Scatter(
                          x=df_city.date_mutation,
                          y=df_city['mean_price_msquare'],
                          name=str('Square meter price'),
                          line = dict(color='rgba('+color+', 0.9)', width=1),
                          line_shape='spline')

          trace_volume = go.Scatter(
                              x=df_city.date_mutation,
                              y=df_city['number_transaction'],
                              name=str('Sales volume'),
                              line = dict(color='rgba('+color+', 0.3)', width=1),
                              line_shape='spline',
                              fillcolor='rgba('+color+', 0.2)',
                              fill='tozeroy' )

          return trace_price, trace_volume

      def set_layout_yaxis(fig, cols):
          fig.layout.yaxis.update(title='Price per square meter')
          if cols ==1 : fig.layout.yaxis2.update(title='Sales volume')
          elif cols ==2 : fig.layout.yaxis4.update(title='Sales volume')
          elif cols ==3 : fig.layout.yaxis6.update(title='Sales volume')
          elif cols ==4 : fig.layout.yaxis8.update(title='Sales volume')
          else : print('too much columns')
          return fig

      def get_multiplot_price_volume(df, list_color, rows, cols):

          fig = make_subplots(rows=rows,
                              cols=cols,
                              print_grid=True,
                              horizontal_spacing=0.2,
                              subplot_titles=df.nom_commune.unique(),
                              specs=[[{"secondary_y": True} for x in range(cols)] for y in range(rows)])

          coord = [[x+1, y+1] for x in range(rows) for y in range(cols)]

          cnt = 0
          for city in df.nom_commune.unique():
              trace_price, trace_volume = get_trace_city(df, city, color=list_color[cnt])

              fig.add_trace(trace_price, coord[cnt][0], coord[cnt][1], secondary_y=False)
              fig.add_trace(trace_volume, coord[cnt][0], coord[cnt][1], secondary_y=True)

              cnt += 1

          fig = set_layout_yaxis(fig, cols)

          fig.layout.update(title='Evolution of the price per square meter & the number of transactions',
                        autosize= False,
                        width= 1000,
                        height= 900,
                        #showlegend=False,
                        hovermode='x',
                        paper_bgcolor='rgba(0,0,0,0)',
                        plot_bgcolor='rgba(0,0,0,0)')
          return fig

      df_resample = resample_monthly_df(df)

      list_color = ['204,0,0','204,102,0', '153,153,0', '102,204,0', '0,153,0', '0,204,204', '0,102,204','0,0,255', '102,0,204', '153,0,76']

      fig = get_multiplot_price_volume(df_resample, list_color, 5, 2)
      fig.show()
      </code></pre>


      <div style="grid-column:1/4; width:78%; margin: auto; text-align: center;margin-right:0px;">
        <iframe src= "plot_french_market_overview/multi_plot.html", width="100%", height="930px", frameBorder="0" style="grid-column:1/4; width:100%; "></iframe> <!-- style="margin-left:150px;" -->
      </div>

      <span class="text_article">

        We can observe that, from october 2018, the number of sales decrease sharply for Montpellier, Lyon and Rennes. This explains the volatility of prices for those cities which is then much more important.</br></br>
        The reason for missing data is that some mutations are not provided due to the fact they have not been registered yet.</br></br>

        It is possible to smooth the time series in order to mitigate extreme values and therefore, to have a closer and more legible representation of reality.

      </span>
      <iframe src= "plot_french_market_overview/price_evolution.html", width="100%", height="600", frameBorder="0"></iframe>

      <span class="title_article" style="font-size: 30px;"><strong>Part II. Highlight of some housing price related variables</strong> </span>



      <span class="subtitle_article"><strong>Load dataframe from database</strong></span>


    </article>
    <!-- ############################################################### -->

  </main>


  <footer class="footer">
      <p><span class="footer__copyright">&copy;</span> 2019 LJPR</p>
      <p>Crafted with <i class="fas fa-heart footer__icon"></i> by <a href="" target="_blank" class="footer__signature">Louis jpr</a></p>
  </footer>
</div>
  <script>
    function show_hide_div(id) {
      if ($('#'+id).css('display') == 'none') {
        $('#'+id).show(500);
      }else{
        $('#'+id).hide(500);
      }
      return false;
    }
  </script>
  <script src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
  <script src='https://www.amcharts.com/lib/3/amcharts.js'></script>
  <script src='https://www.amcharts.com/lib/3/serial.js'></script>
  <script src='https://www.amcharts.com/lib/3/themes/light.js'></script>
  <script defer src="../../../js/script.js"></script>
  <script defer type="text/javascript"> $("#includedSidenav").load("../../../sidenav.html");</script>

</body>
</html>
